<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Cal - Gamified Nutrition & Fitness</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#cc1e0f',
                        'primary-dark': '#a01810',
                        background: '#f9f9f9'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            background: #cc1e0f;
            animation: confetti-fall 4s ease-out forwards;
            z-index: 9999;
            border-radius: 2px;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-20vh) rotate(0deg) scale(1);
                opacity: 1;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(120vh) rotate(720deg) scale(0.5);
                opacity: 0;
            }
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .popup-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        @keyframes bounce-in {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .bounce-in {
            animation: bounce-in 0.6s ease-out;
        }
        
        .bottom-nav {
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .countdown-timer {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            animation: pulse 2s infinite;
        }
        
        .expired-event {
            opacity: 0.6;
            filter: grayscale(50%);
        }
        
        .expired-badge {
            background: #6b7280;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-background min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="text-2xl">üî•</div>
                    <h1 class="text-2xl font-bold text-primary">E-Cal</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2 bg-primary/10 px-3 py-1 rounded-full">
                        <span class="text-sm font-medium text-primary">1,250 pts</span>
                        <div class="text-sm">‚≠ê</div>
                    </div>
                    <!-- Admin Badge -->
                    <div class="flex items-center space-x-2 bg-yellow-100 px-3 py-1 rounded-full" id="admin-badge" style="display: none;">
                        <span class="text-sm font-medium text-yellow-800">üëë Admin</span>
                    </div>
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white font-medium">
                        U
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-20">
        <!-- Tab Navigation -->
        <div class="flex space-x-1 bg-white p-1 rounded-lg shadow-sm mb-6">
            <button onclick="showTab('challenges')" id="tab-challenges" class="flex-1 py-2 px-4 text-sm font-medium rounded-md bg-primary text-white">
                Challenge Board
            </button>
            <button onclick="showTab('my-challenges')" id="tab-my-challenges" class="flex-1 py-2 px-4 text-sm font-medium rounded-md text-gray-600 hover:text-primary">
                My Challenges
            </button>
            <button onclick="showTab('events')" id="tab-events" class="flex-1 py-2 px-4 text-sm font-medium rounded-md text-gray-600 hover:text-primary">
                Events
            </button>
            <button onclick="showTab('leaderboard')" id="tab-leaderboard" class="flex-1 py-2 px-4 text-sm font-medium rounded-md text-gray-600 hover:text-primary">
                Leaderboard
            </button>
        </div>

        <!-- Challenge Board Tab -->
        <div id="challenges-tab" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Challenge Board</h2>
                <!-- Admin Create Button -->
                <button onclick="showCreateChallenge()" class="admin-only bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2" style="display: none;">
                    <span>‚ûï</span>
                    <span>Create Challenge</span>
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6" id="challenge-board-grid">
                <!-- Challenge Cards will be loaded from database -->
            </div>
        </div>

        <!-- My Challenges Tab -->
        <div id="my-challenges-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">My Challenges</h2>
                <div class="text-sm text-gray-600">üî• Keep your streak alive!</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6" id="my-challenges-grid">
                <!-- User challenges will be loaded from database -->
            </div>
        </div>

        <!-- Events Tab -->
        <div id="events-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Special Events</h2>
                <!-- Admin Create Button -->
                <button onclick="showCreateEvent()" class="admin-only bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2" style="display: none;">
                    <span>‚ûï</span>
                    <span>Create Event</span>
                </button>
            </div>
            
            <div class="space-y-6" id="events-container">
                <!-- Events will be loaded from database -->
            </div>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboard-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Monthly Leaderboard</h2>
                <div class="text-sm text-gray-600">üèÜ Top 10 get rewards!</div>
            </div>
            
            <!-- Your Rank Section -->
            <div class="bg-gradient-to-r from-primary to-red-600 rounded-xl p-6 text-white mb-6">
                <div class="text-center">
                    <div class="text-4xl mb-2">üëë</div>
                    <h3 class="text-xl font-bold mb-2">Your Current Rank</h3>
                    <div class="flex items-center justify-center space-x-6">
                        <div class="text-center">
                            <div class="text-3xl font-bold" id="user-rank">#4</div>
                            <div class="text-sm text-red-100">Position</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold" id="user-points">1,250</div>
                            <div class="text-sm text-red-100">Points</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold">+85</div>
                            <div class="text-sm text-red-100">This Week</div>
                        </div>
                    </div>
                    <div class="mt-4 text-sm text-red-100">
                        üéØ You need 930 more points to reach #3!
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm overflow-hidden" id="leaderboard-container">
                <!-- Leaderboard will be loaded from database -->
            </div>
        </div>
    </main>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-gray-100 bottom-nav md:hidden">
        <div class="flex justify-around py-3">
            <button onclick="showTab('challenges')" class="flex flex-col items-center py-2 px-3 text-primary transition-all duration-200">
                <div class="w-6 h-6 mb-1 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.293l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <span class="text-xs font-medium">Challenges</span>
            </button>
            <button onclick="showTab('my-challenges')" class="flex flex-col items-center py-2 px-3 text-gray-400 hover:text-gray-600 transition-all duration-200">
                <div class="w-6 h-6 mb-1 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 102 0V3h4v1a1 1 0 102 0V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <span class="text-xs">My Tasks</span>
            </button>
            <button onclick="showTab('events')" class="flex flex-col items-center py-2 px-3 text-gray-400 hover:text-gray-600 transition-all duration-200">
                <div class="w-6 h-6 mb-1 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <span class="text-xs">Events</span>
            </button>
            <button onclick="showTab('leaderboard')" class="flex flex-col items-center py-2 px-3 text-gray-400 hover:text-gray-600 transition-all duration-200">
                <div class="w-6 h-6 mb-1 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                </div>
                <span class="text-xs">Ranking</span>
            </button>
        </div>
    </nav>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://fmsikqggaxxbytrndvbv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtc2lrcWdnYXh4Ynl0cm5kdmJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTU2NTgsImV4cCI6MjA3MTY5MTY1OH0._A4hgYNsL4JdMrFuTilMHyrEr6TD8f_PulALWT5GoFg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global user data
        let currentUser = null;
        let lineUserId = null;
        let isAdmin = false;
        
        // LIFF initialization
        async function initLIFF() {
            try {
                await liff.init({ liffId: "2007859046-ZlYy9oYr" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                lineUserId = profile.userId;
                
                // Store in localStorage
                window.localStorage.setItem("lineUserId", lineUserId);
                console.log("LINE user ID:", lineUserId);
                
                // Initialize user in database
                await initializeUser(profile);
                
                // Load user data
                await loadUserData();
                
            } catch (e) {
                console.error("LIFF init error", e);
                // Fallback for development
                lineUserId = 'demo_user_' + Date.now();
                window.localStorage.setItem("lineUserId", lineUserId);
                await initializeUser({
                    userId: lineUserId,
                    displayName: 'Demo User',
                    pictureUrl: null
                });
                await loadUserData();
            }
        }
        
        // Initialize user in database
        async function initializeUser(profile) {
            try {
                // Check if user exists
                const { data: existingUser, error: fetchError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('line_user_id', profile.userId)
                    .single();
                
                if (existingUser) {
                    currentUser = existingUser;
                    console.log('Existing user loaded:', existingUser);
                } else {
                    // Create new user
                    const { data: newUser, error: createError } = await supabase
                        .from('users')
                        .insert([{
                            line_user_id: profile.userId,
                            display_name: profile.displayName || 'User',
                            picture_url: profile.pictureUrl,
                            total_points: 1250, // Starting points for demo
                            current_rank: 4
                        }])
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Error creating user:', createError);
                        return;
                    }
                    
                    currentUser = newUser;
                    console.log('New user created:', newUser);
                }
            } catch (error) {
                console.error('Error initializing user:', error);
            }
        }
        
        // Load user data and update UI
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                // Update points display
                const pointsElement = document.querySelector('.bg-primary\\/10 .text-primary');
                if (pointsElement) {
                    pointsElement.textContent = currentUser.total_points.toLocaleString() + ' pts';
                }
                
                // Update admin status
                if (currentUser.is_admin) {
                    document.getElementById('admin-badge').style.display = 'flex';
                    isAdmin = true;
                    toggleAdminElements();
                }
                
                // Load challenges from database
                await loadChallenges();
                
                // Load events from database
                await loadEvents();
                
                // Load user challenges
                await loadUserChallenges();
                
                // Load user events
                await loadUserEvents();
                
                // Update leaderboard
                await updateLeaderboard();
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Demo data
        const demoChallenges = [
            {
                id: 'demo_1',
                title: '10,000 Steps Daily',
                emoji: 'üö∂‚Äç‚ôÇÔ∏è',
                description: 'Walk 10,000 steps every day for better health',
                duration_days: 30,
                challenge_type: 'standard',
                join_points: 10,
                daily_points: 5,
                completion_points: 100,
                is_active: true
            },
            {
                id: 'demo_2',
                title: 'Drink 8 Glasses of Water',
                emoji: 'üíß',
                description: 'Stay hydrated with 8 glasses of water daily',
                duration_days: 21,
                challenge_type: 'standard',
                join_points: 8,
                daily_points: 3,
                completion_points: 75,
                is_active: true
            },
            {
                id: 'demo_3',
                title: 'No Sugar Challenge',
                emoji: 'üö´üç≠',
                description: 'Eliminate added sugars from your diet',
                duration_days: 14,
                challenge_type: 'premium',
                join_points: 15,
                daily_points: 8,
                completion_points: 150,
                is_active: true
            },
            {
                id: 'demo_4',
                title: '5-Minute Meditation',
                emoji: 'üßò‚Äç‚ôÄÔ∏è',
                description: 'Practice mindfulness with daily meditation',
                duration_days: 28,
                challenge_type: 'standard',
                join_points: 12,
                daily_points: 4,
                completion_points: 90,
                is_active: true
            },
            {
                id: 'demo_5',
                title: 'Protein Power Month',
                emoji: 'ü•©',
                description: 'Meet your daily protein goals every day',
                duration_days: 30,
                challenge_type: 'premium',
                join_points: 20,
                daily_points: 6,
                completion_points: 200,
                is_active: true
            },
            {
                id: 'demo_6',
                title: 'Early Bird Challenge',
                emoji: 'üåÖ',
                description: 'Wake up before 7 AM every day',
                duration_days: 21,
                challenge_type: 'standard',
                join_points: 10,
                daily_points: 5,
                completion_points: 80,
                is_active: true
            }
        ];

        const demoEvents = [
            {
                id: 'event_1',
                title: 'New Year Fitness Blast',
                emoji: 'üéÜ',
                description: 'Kick off the new year with intensive workouts and nutrition tracking!',
                event_type: 'featured',
                start_date: '2024-01-01',
                end_date: '2024-01-07',
                start_time: '06:00',
                end_time: '22:00',
                join_points: 25,
                daily_points: 10,
                completion_points: 300,
                is_active: true
            },
            {
                id: 'event_2',
                title: 'Weekend Warrior',
                emoji: '‚ö°',
                description: 'Double your weekend activities and earn bonus points!',
                event_type: 'weekend',
                start_date: '2024-01-06',
                end_date: '2024-01-07',
                start_time: '08:00',
                end_time: '20:00',
                join_points: 15,
                daily_points: 8,
                completion_points: 100,
                is_active: true
            },
            {
                id: 'event_3',
                title: 'Mindful Monday',
                emoji: 'üß†',
                description: 'Start your week with meditation and mental wellness activities',
                event_type: 'weekly',
                start_date: '2024-01-08',
                end_date: '2024-01-08',
                start_time: '06:00',
                end_time: '23:59',
                join_points: 10,
                daily_points: 12,
                completion_points: 50,
                is_active: true
            },
            {
                id: 'event_4',
                title: 'Transformation Challenge',
                emoji: 'ü¶ã',
                description: 'A month-long journey to transform your health habits',
                event_type: 'monthly',
                start_date: '2024-01-01',
                end_date: '2024-01-31',
                start_time: '00:00',
                end_time: '23:59',
                join_points: 50,
                daily_points: 15,
                completion_points: 500,
                is_active: true
            }
        ];

        const demoLeaderboard = [
            { display_name: 'FitnessPro_TH', total_points: 3250, current_rank: 1 },
            { display_name: 'HealthyLife_BKK', total_points: 2890, current_rank: 2 },
            { display_name: 'WellnessWarrior', total_points: 2180, current_rank: 3 },
            { display_name: 'You', total_points: 1250, current_rank: 4 },
            { display_name: 'ActiveAce_CM', total_points: 1120, current_rank: 5 },
            { display_name: 'NutriNinja', total_points: 980, current_rank: 6 },
            { display_name: 'FitFam_HDY', total_points: 875, current_rank: 7 },
            { display_name: 'HealthHero_PKT', total_points: 720, current_rank: 8 },
            { display_name: 'WellnessWin', total_points: 650, current_rank: 9 },
            { display_name: 'FitJourney_CNX', total_points: 580, current_rank: 10 }
        ];

        // Load challenges from database
        async function loadChallenges() {
            try {
                const { data: challenges, error } = await supabase
                    .from('challenges')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });
                
                if (error || !challenges || challenges.length === 0) {
                    console.log('Using demo challenges data');
                    // Use demo data if database is not available
                    const challengeGrid = document.getElementById('challenge-board-grid');
                    challengeGrid.innerHTML = '';
                    
                    demoChallenges.forEach(challenge => {
                        const challengeCard = createChallengeCard(challenge);
                        challengeGrid.appendChild(challengeCard);
                    });
                    return;
                }
                
                const challengeGrid = document.getElementById('challenge-board-grid');
                challengeGrid.innerHTML = '';
                
                challenges.forEach(challenge => {
                    const challengeCard = createChallengeCard(challenge);
                    challengeGrid.appendChild(challengeCard);
                });
                
            } catch (error) {
                console.log('Database error, using demo data:', error);
                // Fallback to demo data
                const challengeGrid = document.getElementById('challenge-board-grid');
                challengeGrid.innerHTML = '';
                
                demoChallenges.forEach(challenge => {
                    const challengeCard = createChallengeCard(challenge);
                    challengeGrid.appendChild(challengeCard);
                });
            }
        }
        
        // Load events from database
        async function loadEvents() {
            try {
                const { data: events, error } = await supabase
                    .from('events')
                    .select('*')
                    .eq('is_active', true)
                    .order('start_date', { ascending: true });
                
                if (error || !events || events.length === 0) {
                    console.log('Using demo events data');
                    // Use demo data if database is not available
                    const eventsContainer = document.getElementById('events-container');
                    eventsContainer.innerHTML = '';
                    
                    demoEvents.forEach(event => {
                        const eventCard = createEventCard(event);
                        eventsContainer.appendChild(eventCard);
                    });
                    
                    // Start countdown timers for demo events
                    startEventCountdowns();
                    return;
                }
                
                const eventsContainer = document.getElementById('events-container');
                eventsContainer.innerHTML = '';
                
                events.forEach(event => {
                    const eventCard = createEventCard(event);
                    eventsContainer.appendChild(eventCard);
                });
                
                // Start countdown timers
                startEventCountdowns();
                
            } catch (error) {
                console.log('Database error, using demo events data:', error);
                // Fallback to demo data
                const eventsContainer = document.getElementById('events-container');
                eventsContainer.innerHTML = '';
                
                demoEvents.forEach(event => {
                    const eventCard = createEventCard(event);
                    eventsContainer.appendChild(eventCard);
                });
                
                // Start countdown timers for demo events
                startEventCountdowns();
            }
        }
        
        // Create challenge card element
        function createChallengeCard(challenge) {
            const card = document.createElement('div');
            card.className = `bg-white rounded-xl shadow-sm p-6 card-hover ${challenge.challenge_type === 'premium' ? 'border-2 border-yellow-400' : ''}`;
            card.setAttribute('data-challenge-card', challenge.id);
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="text-4xl">${challenge.emoji}</div>
                    ${challenge.challenge_type === 'premium' ? '<div class="bg-yellow-400 text-yellow-900 text-xs px-2 py-1 rounded-full font-medium">PREMIUM</div>' : ''}
                </div>
                <h3 class="font-semibold text-lg mb-2">${challenge.title}</h3>
                <div class="text-sm text-gray-600 mb-4">
                    <div class="flex items-center space-x-2 mb-1">
                        <span>‚è±Ô∏è ${challenge.duration_days} days</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span>üë• 0 participants</span>
                    </div>
                    <div class="text-xs mt-2 text-gray-500">${challenge.description || ''}</div>
                </div>
                <button onclick="joinChallenge('${challenge.id}')" class="w-full ${challenge.challenge_type === 'premium' ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-primary hover:bg-primary-dark'} text-white py-2 px-4 rounded-lg font-medium transition-colors">
                    ${challenge.challenge_type === 'premium' ? `Join Premium (+${challenge.join_points} pts)` : `Join Challenge (+${challenge.join_points} pts)`}
                </button>
            `;
            
            return card;
        }
        
        // Create event card element
        function createEventCard(event) {
            const card = document.createElement('div');
            const colorMap = {
                'featured': { from: 'purple-500', to: 'pink-500' },
                'weekend': { from: 'orange-500', to: 'red-500' },
                'weekly': { from: 'green-500', to: 'emerald-500' },
                'monthly': { from: 'blue-500', to: 'indigo-500' }
            };
            
            const colors = colorMap[event.event_type] || { from: 'red-500', to: 'pink-500' };
            
            card.className = `bg-gradient-to-r from-${colors.from} to-${colors.to} rounded-xl p-6 text-white relative overflow-hidden`;
            
            const startDate = new Date(event.start_date);
            const endDate = new Date(event.end_date);
            const dateRange = `${startDate.getDate()}-${endDate.getDate()} ${startDate.toLocaleDateString('th-TH', { month: 'short' })} ${startDate.getFullYear()}`;
            const timeRange = `${event.start_time}-${event.end_time} ‡∏ô.`;
            
            card.innerHTML = `
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16"></div>
                <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full translate-y-12 -translate-x-12"></div>
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-4xl">${event.emoji}</div>
                        <div class="bg-white/20 px-3 py-1 rounded-full text-sm font-medium">
                            ${event.event_type.toUpperCase()}
                        </div>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">${event.title}</h3>
                    <p class="text-white/90 mb-4">${event.description}</p>
                    <div class="flex items-center space-x-4 mb-4">
                        <div class="countdown-timer" id="countdown-${event.id}">
                            ‚è∞ Loading...
                        </div>
                        <div class="flex items-center space-x-2">
                            <span>üë•</span>
                            <span class="text-sm">0 participants</span>
                        </div>
                    </div>
                    <div class="text-sm text-white/90 mb-2">
                        üìÖ ${dateRange} | ‚è∞ ${timeRange}
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="joinEvent('${event.id}')" class="bg-white text-gray-800 px-6 py-2 rounded-lg font-medium hover:bg-gray-100 transition-colors">
                            Join Event (+${event.join_points} pts)
                        </button>
                        <button onclick="showEventDetails('${event.id}')" class="bg-white/20 text-white px-4 py-2 rounded-lg font-medium hover:bg-white/30 transition-colors">
                            View Details
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // Load user's active challenges
        async function loadUserChallenges() {
            try {
                const { data: userChallenges, error } = await supabase
                    .from('user_challenges')
                    .select(`
                        *,
                        challenges (*)
                    `)
                    .eq('user_id', currentUser?.id)
                    .eq('is_completed', false);
                
                if (error || !userChallenges || userChallenges.length === 0) {
                    console.log('Using demo user challenges');
                    // Load demo user challenges
                    loadDemoUserChallenges();
                    return;
                }
                
                // Clear existing challenges in My Challenges tab
                const myChallengesGrid = document.getElementById('my-challenges-grid');
                const existingChallenges = myChallengesGrid.querySelectorAll('[data-challenge]:not(.bg-gradient-to-br)');
                existingChallenges.forEach(card => card.remove());
                
                // Add user challenges to My Challenges tab
                userChallenges.forEach(userChallenge => {
                    const challenge = userChallenge.challenges;
                    const challengeData = {
                        emoji: challenge.emoji,
                        title: challenge.title,
                        progress: userChallenge.current_progress,
                        total: challenge.duration_days,
                        streak: userChallenge.current_streak,
                        isPremium: challenge.challenge_type === 'premium'
                    };
                    
                    addToMyChallenges(`db_challenge_${challenge.id}`, challengeData);
                });
                
            } catch (error) {
                console.log('Database error, using demo user challenges:', error);
                loadDemoUserChallenges();
            }
        }
        
        // Load demo user challenges
        function loadDemoUserChallenges() {
            // Clear existing challenges in My Challenges tab
            const myChallengesGrid = document.getElementById('my-challenges-grid');
            const existingChallenges = myChallengesGrid.querySelectorAll('[data-challenge]:not(.bg-gradient-to-br)');
            existingChallenges.forEach(card => card.remove());
            
            // Add some demo active challenges
            const demoUserChallenges = [
                {
                    emoji: 'üö∂‚Äç‚ôÇÔ∏è',
                    title: '10,000 Steps Daily',
                    progress: 12,
                    total: 30,
                    streak: 5,
                    isPremium: false
                },
                {
                    emoji: 'üíß',
                    title: 'Drink 8 Glasses of Water',
                    progress: 8,
                    total: 21,
                    streak: 8,
                    isPremium: false
                },
                {
                    emoji: 'üö´üç≠',
                    title: 'No Sugar Challenge',
                    progress: 3,
                    total: 14,
                    streak: 3,
                    isPremium: true
                }
            ];
            
            demoUserChallenges.forEach((challenge, index) => {
                addToMyChallenges(`demo_user_challenge_${index}`, challenge);
            });
            
            // Add completed challenge example
            addCompletedChallengeExample();
        }
        
        // Load user's active events
        async function loadUserEvents() {
            try {
                const { data: userEvents, error } = await supabase
                    .from('user_events')
                    .select(`
                        *,
                        events (*)
                    `)
                    .eq('user_id', currentUser.id)
                    .eq('is_completed', false);
                
                if (error) {
                    console.error('Error loading user events:', error);
                    return;
                }
                
                // Add user events to My Challenges tab
                userEvents.forEach(userEvent => {
                    const event = userEvent.events;
                    const eventData = {
                        emoji: event.emoji,
                        title: event.title,
                        progress: userEvent.current_progress,
                        total: Math.ceil((new Date(event.end_date) - new Date(event.start_date)) / (1000 * 60 * 60 * 24)) + 1,
                        streak: userEvent.current_streak,
                        points: event.completion_points,
                        startDate: event.start_date,
                        startTime: event.start_time
                    };
                    
                    addEventToMyChallenges(`db_event_${event.id}`, eventData);
                });
                
            } catch (error) {
                console.error('Error loading user events:', error);
            }
        }
        
        // Update leaderboard with real data
        async function updateLeaderboard() {
            try {
                const { data: leaderboard, error } = await supabase
                    .from('users')
                    .select('display_name, total_points, current_rank')
                    .order('total_points', { ascending: false })
                    .limit(10);
                
                if (error || !leaderboard || leaderboard.length === 0) {
                    console.log('Using demo leaderboard data');
                    // Use demo data if database is not available
                    displayLeaderboard(demoLeaderboard);
                    return;
                }
                
                displayLeaderboard(leaderboard);
                
            } catch (error) {
                console.log('Database error, using demo leaderboard data:', error);
                // Fallback to demo data
                displayLeaderboard(demoLeaderboard);
            }
        }
        
        // Display leaderboard data
        function displayLeaderboard(leaderboardData) {
            // Update user rank display
            const userRankElement = document.getElementById('user-rank');
            const userPointsElement = document.getElementById('user-points');
            
            if (userRankElement) {
                userRankElement.textContent = '#4';
            }
            
            if (userPointsElement) {
                userPointsElement.textContent = '1,250';
            }
            
            // Create leaderboard table
            const leaderboardContainer = document.getElementById('leaderboard-container');
            leaderboardContainer.innerHTML = `
                <div class="divide-y divide-gray-200">
                    ${leaderboardData.map((user, index) => `
                        <div class="flex items-center justify-between p-4 ${user.display_name === 'You' ? 'bg-primary/5 border-l-4 border-primary' : ''}">
                            <div class="flex items-center space-x-4">
                                <div class="flex-shrink-0">
                                    ${index < 3 ? 
                                        `<div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${
                                            index === 0 ? 'bg-yellow-500' : 
                                            index === 1 ? 'bg-gray-400' : 
                                            'bg-orange-600'
                                        }">
                                            ${index + 1}
                                        </div>` :
                                        `<div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 font-medium">
                                            ${index + 1}
                                        </div>`
                                    }
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900 ${user.display_name === 'You' ? 'text-primary font-semibold' : ''}">${user.display_name}</div>
                                    ${user.display_name === 'You' ? '<div class="text-sm text-primary">That\'s you! üéâ</div>' : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-gray-900">${user.total_points.toLocaleString()}</div>
                                <div class="text-sm text-gray-500">points</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Database functions for challenges and events
        async function joinChallengeDB(challengeId) {
            if (!currentUser) return false;
            
            try {
                // Get challenge details
                const { data: challenge, error: challengeError } = await supabase
                    .from('challenges')
                    .select('*')
                    .eq('id', challengeId)
                    .single();
                
                if (challengeError) {
                    console.error('Error fetching challenge:', challengeError);
                    return false;
                }
                
                // Join challenge
                const { data: userChallenge, error: joinError } = await supabase
                    .from('user_challenges')
                    .insert([{
                        user_id: currentUser.id,
                        challenge_id: challengeId,
                        current_progress: 0,
                        current_streak: 0
                    }])
                    .select()
                    .single();
                
                if (joinError) {
                    console.error('Error joining challenge:', joinError);
                    return false;
                }
                
                // Add join points
                await addPoints(challenge.join_points, 'join', 'challenge', challengeId, `Joined ${challenge.title}`);
                
                return true;
                
            } catch (error) {
                console.error('Error joining challenge:', error);
                return false;
            }
        }
        
        async function joinEventDB(eventId) {
            if (!currentUser) return false;
            
            try {
                // Get event details
                const { data: event, error: eventError } = await supabase
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (eventError) {
                    console.error('Error fetching event:', eventError);
                    return false;
                }
                
                // Join event
                const { data: userEvent, error: joinError } = await supabase
                    .from('user_events')
                    .insert([{
                        user_id: currentUser.id,
                        event_id: eventId,
                        current_progress: 0,
                        current_streak: 0
                    }])
                    .select()
                    .single();
                
                if (joinError) {
                    console.error('Error joining event:', joinError);
                    return false;
                }
                
                // Add join points
                await addPoints(event.join_points, 'join', 'event', eventId, `Joined ${event.title}`);
                
                return true;
                
            } catch (error) {
                console.error('Error joining event:', error);
                return false;
            }
        }
        
        async function markDoneDB(challengeId, isEvent = false) {
            if (!currentUser) return false;
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const table = isEvent ? 'user_events' : 'user_challenges';
                const sourceTable = isEvent ? 'events' : 'challenges';
                const idField = isEvent ? 'event_id' : 'challenge_id';
                
                // Check if already done today
                const { data: existingActivity, error: activityError } = await supabase
                    .from('daily_activities')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq(idField, challengeId)
                    .eq('activity_date', today)
                    .single();
                
                if (existingActivity) {
                    showToast("‚úÖ Already completed today! Come back tomorrow!", 'info');
                    return false;
                }
                
                // Get current progress
                const { data: userProgress, error: progressError } = await supabase
                    .from(table)
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq(idField, challengeId)
                    .single();
                
                if (progressError) {
                    console.error('Error fetching progress:', progressError);
                    return false;
                }
                
                // Get source details for points
                const { data: source, error: sourceError } = await supabase
                    .from(sourceTable)
                    .select('*')
                    .eq('id', challengeId)
                    .single();
                
                if (sourceError) {
                    console.error('Error fetching source:', sourceError);
                    return false;
                }
                
                // Update progress
                const newProgress = userProgress.current_progress + 1;
                const newStreak = userProgress.current_streak + 1;
                const isCompleted = newProgress >= (isEvent ? 
                    Math.ceil((new Date(source.end_date) - new Date(source.start_date)) / (1000 * 60 * 60 * 24)) + 1 : 
                    source.duration_days);
                
                const { error: updateError } = await supabase
                    .from(table)
                    .update({
                        current_progress: newProgress,
                        current_streak: newStreak,
                        is_completed: isCompleted,
                        completed_at: isCompleted ? new Date().toISOString() : null,
                        last_activity_date: today
                    })
                    .eq('user_id', currentUser.id)
                    .eq(idField, challengeId);
                
                if (updateError) {
                    console.error('Error updating progress:', updateError);
                    return false;
                }
                
                // Record daily activity
                const { error: activityInsertError } = await supabase
                    .from('daily_activities')
                    .insert([{
                        user_id: currentUser.id,
                        [idField]: challengeId,
                        activity_date: today,
                        points_earned: source.daily_points,
                        activity_type: isEvent ? 'event' : 'challenge'
                    }]);
                
                if (activityInsertError) {
                    console.error('Error recording activity:', activityInsertError);
                }
                
                // Add daily points
                await addPoints(source.daily_points, 'daily', isEvent ? 'event' : 'challenge', challengeId, `Daily progress on ${source.title}`);
                
                // Add completion points if completed
                if (isCompleted) {
                    await addPoints(source.completion_points, 'completion', isEvent ? 'event' : 'challenge', challengeId, `Completed ${source.title}`);
                }
                
                return true;
                
            } catch (error) {
                console.error('Error marking done:', error);
                return false;
            }
        }
        
        async function addPoints(points, type, sourceType, sourceId, description) {
            if (!currentUser) return;
            
            try {
                // Add to points history
                const { error: historyError } = await supabase
                    .from('points_history')
                    .insert([{
                        user_id: currentUser.id,
                        points_change: points,
                        points_type: type,
                        source_type: sourceType,
                        source_id: sourceId,
                        description: description
                    }]);
                
                if (historyError) {
                    console.error('Error adding points history:', historyError);
                }
                
                // Update user total points
                const newTotal = currentUser.total_points + points;
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ total_points: newTotal })
                    .eq('id', currentUser.id);
                
                if (updateError) {
                    console.error('Error updating user points:', updateError);
                    return;
                }
                
                // Update local user data
                currentUser.total_points = newTotal;
                
                // Update UI
                const pointsElement = document.querySelector('.bg-primary\\/10 .text-primary');
                if (pointsElement) {
                    pointsElement.textContent = newTotal.toLocaleString() + ' pts';
                }
                
            } catch (error) {
                console.error('Error adding points:', error);
            }
        }

        // Tab switching functionality
        function showTab(tabName) {
            try {
                console.log('Switching to tab:', tabName);
                
                // Hide all tabs
                const tabs = document.querySelectorAll('.tab-content');
                tabs.forEach(tab => {
                    if (tab) {
                        tab.classList.add('hidden');
                    }
                });
                
                // Remove active state from all tab buttons
                const tabButtons = document.querySelectorAll('[id^="tab-"]');
                tabButtons.forEach(btn => {
                    if (btn) {
                        btn.classList.remove('bg-primary', 'text-white');
                        btn.classList.add('text-gray-600', 'hover:text-primary');
                    }
                });
                
                // Show selected tab
                const selectedTab = document.getElementById(tabName + '-tab');
                if (selectedTab) {
                    selectedTab.classList.remove('hidden');
                    console.log('Tab shown:', tabName);
                }
                
                // Activate selected tab button
                const activeBtn = document.getElementById('tab-' + tabName);
                if (activeBtn) {
                    activeBtn.classList.add('bg-primary', 'text-white');
                    activeBtn.classList.remove('text-gray-600', 'hover:text-primary');
                }
                
                // Update mobile nav
                updateMobileNav(tabName);
            } catch (error) {
                console.error('Tab switching error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô tab: ' + error.message);
            }
        }
        
        function updateMobileNav(activeTab) {
            document.querySelectorAll('nav button').forEach(btn => {
                btn.classList.remove('text-primary');
                btn.classList.add('text-gray-400');
            });
            
            // This is a simplified version - in a real app you'd have proper mapping
            const navButtons = document.querySelectorAll('nav button');
            if (activeTab === 'challenges') {
                navButtons[0].classList.remove('text-gray-400');
                navButtons[0].classList.add('text-primary');
            }
            if (activeTab === 'my-challenges') {
                navButtons[1].classList.remove('text-gray-400');
                navButtons[1].classList.add('text-primary');
            }
            if (activeTab === 'events') {
                navButtons[2].classList.remove('text-gray-400');
                navButtons[2].classList.add('text-primary');
            }
            if (activeTab === 'leaderboard') {
                navButtons[3].classList.remove('text-gray-400');
                navButtons[3].classList.add('text-primary');
            }
        }

        // Challenge joining functionality
        async function joinChallenge(challengeId) {
            try {
                console.log('Joining challenge:', challengeId);
                
                // Check if it's a database challenge
                if (challengeId.startsWith('db_challenge_') || challengeId.length > 20) {
                    const realChallengeId = challengeId.replace('db_challenge_', '');
                    const success = await joinChallengeDB(realChallengeId);
                    
                    if (success) {
                        showToast("üéâ Challenge joined! Let's crush this!", 'success');
                        // Reload user challenges
                        await loadUserChallenges();
                        // Remove from challenge board
                        const challengeCard = document.querySelector(`[data-challenge-card="${realChallengeId}"]`);
                        if (challengeCard) {
                            challengeCard.style.transform = 'scale(0.8)';
                            challengeCard.style.opacity = '0';
                            challengeCard.style.transition = 'all 0.3s ease';
                            setTimeout(() => challengeCard.remove(), 300);
                        }
                    } else {
                        showToast("‚ùå Failed to join challenge. Please try again!", 'info');
                    }
                    return;
                }
                
                // Fallback for demo challenges
                const existingChallenge = document.querySelector(`[data-challenge="${challengeId}"]`);
                if (existingChallenge) {
                    showToast("Challenge already in your list!", 'info');
                    return;
                }
                
                const messages = [
                    "üéâ Challenge joined! Let's crush this!",
                    "üí™ You're in! Time to show what you've got!",
                    "üî• Welcome to the challenge! Let's go!"
                ];
                
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                showToast(randomMessage, 'success');
                
                // Demo functionality for non-database challenges
                updatePoints(5);
                
            } catch (error) {
                console.log('Join challenge error:', error);
                showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà!", 'info');
            }
        }

        // Event joining functionality
        async function joinEvent(eventId) {
            try {
                console.log('Joining event:', eventId);
                
                // Check if it's a database event
                if (eventId.startsWith('db_event_') || eventId.length > 20) {
                    const realEventId = eventId.replace('db_event_', '');
                    const success = await joinEventDB(realEventId);
                    
                    if (success) {
                        showToast("üéâ Event joined! Let's do this!", 'success');
                        // Reload user events
                        await loadUserEvents();
                    } else {
                        showToast("‚ùå Failed to join event. Please try again!", 'info');
                    }
                    return;
                }
                
                // Fallback for demo events
                const existingEvent = document.querySelector(`[data-challenge="${eventId}"]`);
                if (existingEvent) {
                    showToast("Event already in your challenges!", 'info');
                    return;
                }
                
                showToast("üéâ Event joined! Let's do this!", 'success');
                updatePoints(5);
                
            } catch (error) {
                console.log('Join event error:', error);
                showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà!", 'info');
            }
        }

        // Mark challenge/event as done
        async function markDone(challengeId) {
            try {
                console.log('Marking done:', challengeId);
                
                // Check if it's a database challenge/event
                if (challengeId.startsWith('db_challenge_')) {
                    const realChallengeId = challengeId.replace('db_challenge_', '');
                    const success = await markDoneDB(realChallengeId, false);
                    
                    if (success) {
                        const roastMessages = [
                            `‡πÄ‡∏Æ‡πâ‡∏¢ ‡πÇ‡∏Å‡∏á‡∏õ‡πà‡∏∞‡∏ß‡∏∞?! üòÇ Just kidding, you're amazing! üí™`,
                            `‡∏ß‡πâ‡∏≤‡∏ß! Look who's on fire! üî• Keep it up, superstar! ‚≠ê`,
                            `‡∏≠‡∏¢‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏∞! You're unstoppable! üöÄ E-Cal is proud! üéâ`,
                            `‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! That's what I'm talking about! üíØ You rock! üé∏`,
                            `‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! You're absolutely crushing it! üèÜ Legend! üëë`
                        ];
                        
                        const randomRoast = roastMessages[Math.floor(Math.random() * roastMessages.length)];
                        createConfetti();
                        setTimeout(() => showToast(randomRoast, 'success'), 100);
                        
                        // Update UI
                        updateDoneButton(challengeId);
                        updateChallengeProgress(challengeId);
                        
                        // Reload user data
                        await loadUserChallenges();
                    }
                    return;
                }
                
                if (challengeId.startsWith('db_event_')) {
                    const realEventId = challengeId.replace('db_event_', '');
                    const success = await markDoneDB(realEventId, true);
                    
                    if (success) {
                        const roastMessages = [
                            `‡πÄ‡∏Æ‡πâ‡∏¢ ‡πÇ‡∏Å‡∏á‡∏õ‡πà‡∏∞‡∏ß‡∏∞?! üòÇ Just kidding, you're amazing! üí™`,
                            `‡∏ß‡πâ‡∏≤‡∏ß! Look who's on fire! üî• Keep it up, superstar! ‚≠ê`,
                            `‡∏≠‡∏¢‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏∞! You're unstoppable! üöÄ E-Cal is proud! üéâ`
                        ];
                        
                        const randomRoast = roastMessages[Math.floor(Math.random() * roastMessages.length)];
                        createConfetti();
                        setTimeout(() => showToast(randomRoast, 'success'), 100);
                        
                        // Update UI
                        updateDoneButton(challengeId);
                        updateChallengeProgress(challengeId);
                        
                        // Reload user data
                        await loadUserEvents();
                    }
                    return;
                }
                
                // Fallback for demo challenges/events
                const today = new Date().toDateString();
                const lastDoneKey = `lastDone_${challengeId}`;
                const lastDone = localStorage.getItem(lastDoneKey);
                
                if (lastDone === today) {
                    showToast("‚úÖ Already completed today! Come back tomorrow!", 'info');
                    return;
                }
                
                localStorage.setItem(lastDoneKey, today);
                
                const roastMessages = [
                    `‡πÄ‡∏Æ‡πâ‡∏¢ ‡πÇ‡∏Å‡∏á‡∏õ‡πà‡∏∞‡∏ß‡∏∞?! üòÇ Just kidding, you're amazing! üí™`,
                    `‡∏ß‡πâ‡∏≤‡∏ß! Look who's on fire! üî• Keep it up, superstar! ‚≠ê`,
                    `‡∏≠‡∏¢‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏∞! You're unstoppable! üöÄ E-Cal is proud! üéâ`
                ];
                
                const randomRoast = roastMessages[Math.floor(Math.random() * roastMessages.length)];
                createConfetti();
                setTimeout(() => showToast(randomRoast, 'success'), 100);
                
                updatePoints(2);
                updateDoneButton(challengeId);
                updateChallengeProgress(challengeId);
                
            } catch (error) {
                console.log('Mark done error:', error);
                showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà!", 'info');
            }
        }

        // Helper functions (keeping existing functionality for demo purposes)
        function createConfetti() {
            const colors = ['#cc1e0f', '#fbbf24', '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444'];
            
            for (let i = 0; i < 60; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 3) + 's';
                confetti.style.zIndex = '9999';
                
                document.body.appendChild(confetti);
                
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.remove();
                    }
                }, 6000);
            }
        }

        function showToast(message, type = 'info') {
            try {
                console.log('Showing toast:', message, type);
                
                const toast = document.createElement('div');
                toast.className = `fixed top-20 right-4 z-50 max-w-sm p-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
                
                if (type === 'success') {
                    toast.classList.add('bg-green-500', 'text-white');
                } else {
                    toast.classList.add('bg-blue-500', 'text-white');
                }
                
                toast.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="flex-1">${message}</div>
                        <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                            ‚úï
                        </button>
                    </div>
                `;
                
                document.body.appendChild(toast);
                
                // Animate in
                setTimeout(() => {
                    toast.classList.remove('translate-x-full');
                }, 100);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.remove();
                        }
                    }, 300);
                }, 5000);
            } catch (error) {
                console.log('Toast error:', error);
                alert(message); // Fallback
            }
        }

        function updatePoints(points) {
            if (currentUser) {
                currentUser.total_points += points;
                const pointsElement = document.querySelector('.bg-primary\\/10 .text-primary');
                if (pointsElement) {
                    pointsElement.textContent = currentUser.total_points.toLocaleString() + ' pts';
                }
            }
        }

        function updateDoneButton(challengeId) {
            const challengeCard = document.querySelector(`[data-challenge="${challengeId}"]`);
            if (!challengeCard) return;
            
            const button = challengeCard.querySelector('button[onclick*="markDone"]');
            if (button) {
                button.disabled = true;
                button.classList.remove('bg-green-500', 'hover:bg-green-600', 'bg-purple-500', 'hover:bg-purple-600', 'bg-yellow-500', 'hover:bg-yellow-600');
                button.classList.add('bg-gray-400', 'cursor-not-allowed');
                button.innerHTML = `
                    <span>‚úÖ</span>
                    <span>Completed Today!</span>
                `;
            }
        }

        function updateChallengeProgress(challengeId) {
            const challengeCard = document.querySelector(`[data-challenge="${challengeId}"]`);
            if (!challengeCard) return;
            
            const progressKey = `progress_${challengeId}`;
            const streakKey = `streak_${challengeId}`;
            
            let currentProgress = parseInt(localStorage.getItem(progressKey) || '0') + 1;
            let currentStreak = parseInt(localStorage.getItem(streakKey) || '0') + 1;
            
            localStorage.setItem(progressKey, currentProgress.toString());
            localStorage.setItem(streakKey, currentStreak.toString());
            
            const streakElement = challengeCard.querySelector('.text-orange-500 .font-bold, .text-purple-500 .font-bold');
            const progressText = challengeCard.querySelector('.text-gray-600 span:last-child');
            const progressBar = challengeCard.querySelector('.progress-bar');
            
            if (streakElement) {
                streakElement.textContent = currentStreak;
            }
            
            if (progressText) {
                const progressMatch = progressText.textContent.match(/(\d+)\/(\d+)/);
                if (progressMatch) {
                    const totalDays = parseInt(progressMatch[2]);
                    progressText.textContent = `${currentProgress}/${totalDays} days`;
                    
                    if (progressBar) {
                        const percentage = (currentProgress / totalDays) * 100;
                        progressBar.style.width = percentage + '%';
                    }
                }
            }
        }

        function addToMyChallenges(challengeType, customData = null) {
            const myChallengesContainer = document.getElementById('my-challenges-grid');
            
            if (!customData) return;
            
            const existingChallenge = document.querySelector(`[data-challenge="${challengeType}"]`);
            if (existingChallenge) {
                return;
            }
            
            const isPremium = customData.isPremium;
            const cardClass = isPremium ? 'bg-white rounded-xl shadow-sm p-6 border-2 border-yellow-400' : 'bg-white rounded-xl shadow-sm p-6';
            const buttonPoints = isPremium ? '+4 pts' : '+2 pts';
            const buttonClass = isPremium ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600';
            const progressBarClass = isPremium ? 'bg-yellow-500' : 'bg-primary';
            
            const premiumBadge = isPremium ? `
                <div class="bg-yellow-400 text-yellow-900 text-xs px-2 py-1 rounded-full font-medium mb-2">
                    PREMIUM
                </div>
            ` : '';
            
            const challengeCard = document.createElement('div');
            challengeCard.className = cardClass;
            challengeCard.setAttribute('data-challenge', challengeType);
            
            challengeCard.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="text-3xl">${customData.emoji}</div>
                    <div class="flex items-center space-x-1 ${isPremium ? 'text-yellow-500' : 'text-orange-500'}">
                        <span class="text-lg">üî•</span>
                        <span class="font-bold">${customData.streak}</span>
                    </div>
                </div>
                ${premiumBadge}
                <h3 class="font-semibold text-lg mb-2">${customData.title}</h3>
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Progress</span>
                        <span>${customData.progress}/${customData.total} days</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="${progressBarClass} h-2 rounded-full progress-bar" style="width: ${(customData.progress / customData.total) * 100}%"></div>
                    </div>
                </div>
                <button onclick="markDone('${challengeType}')" class="w-full ${buttonClass} text-white py-2 px-4 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2">
                    <span>‚úÖ</span>
                    <span>Done Today (${buttonPoints})</span>
                </button>
            `;
            
            const completedChallenge = myChallengesContainer.querySelector('.bg-gradient-to-br');
            if (completedChallenge) {
                myChallengesContainer.insertBefore(challengeCard, completedChallenge);
            } else {
                myChallengesContainer.appendChild(challengeCard);
            }
        }

        function addEventToMyChallenges(eventType, event) {
            const myChallengesContainer = document.getElementById('my-challenges-grid');
            
            const now = new Date();
            const startDateTime = new Date(event.startDate + 'T' + event.startTime);
            const hasStarted = now >= startDateTime;
            
            const eventCard = document.createElement('div');
            eventCard.className = 'bg-white rounded-xl shadow-sm p-6 border-2 border-purple-200';
            eventCard.setAttribute('data-challenge', eventType);
            eventCard.setAttribute('data-start-time', event.startDate + 'T' + event.startTime);
            eventCard.setAttribute('data-end-time', event.endTime || '');
            
            let buttonContent = '';
            let statusContent = '';
            
            if (hasStarted) {
                statusContent = `
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Progress</span>
                            <span>${event.progress}/${event.total} days</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-purple-500 h-2 rounded-full progress-bar" style="width: ${(event.progress / event.total) * 100}%"></div>
                        </div>
                    </div>
                `;
                
                buttonContent = `
                    <button onclick="markDone('${eventType}')" class="w-full bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2">
                        <span>‚úÖ</span>
                        <span>Done Today (+3 pts)</span>
                    </button>
                `;
            } else {
                statusContent = `
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Event Status</span>
                            <span>Waiting to Start</span>
                        </div>
                        <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-3 text-center">
                            <div class="text-yellow-800 font-medium mb-1">üïê Event Starts In</div>
                            <div class="countdown-timer-event text-yellow-900 font-bold" id="countdown-start-${eventType}">
                                Loading...
                            </div>
                        </div>
                    </div>
                `;
                
                buttonContent = `
                    <button disabled class="w-full bg-gray-300 text-gray-500 py-2 px-4 rounded-lg font-medium cursor-not-allowed flex items-center justify-center space-x-2">
                        <span>‚è≥</span>
                        <span>Waiting for Event Start</span>
                    </button>
                `;
            }
            
            eventCard.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div class="text-3xl">${event.emoji}</div>
                    <div class="flex items-center space-x-1 text-purple-500">
                        <span class="text-lg">üé™</span>
                        <span class="font-bold">${event.streak}</span>
                    </div>
                </div>
                <h3 class="font-semibold text-lg mb-2">${event.title}</h3>
                ${statusContent}
                ${buttonContent}
            `;
            
            eventCard.setAttribute('data-start-date', event.startDate);
            eventCard.setAttribute('data-start-time', event.startTime);
            
            const firstChild = myChallengesContainer.firstChild;
            myChallengesContainer.insertBefore(eventCard, firstChild);
        }

        function toggleAdminElements() {
            const adminElements = document.querySelectorAll('.admin-only');
            const adminBadge = document.getElementById('admin-badge');
            
            if (isAdmin) {
                adminElements.forEach(el => el.style.display = 'flex');
                if (adminBadge) adminBadge.style.display = 'flex';
            } else {
                adminElements.forEach(el => el.style.display = 'none');
                if (adminBadge) adminBadge.style.display = 'none';
            }
        }

        // Placeholder functions for admin features
        function showCreateChallenge() {
            showToast("üëë Admin feature - Create Challenge coming soon!", 'info');
        }

        function showCreateEvent() {
            showToast("üëë Admin feature - Create Event coming soon!", 'info');
        }

        function showEventDetails(eventId) {
            showToast("Event details coming soon!", 'info');
        }

        // Start countdown timers for events
        function startEventCountdowns() {
            const countdownElements = document.querySelectorAll('[id^="countdown-"]');
            
            countdownElements.forEach(element => {
                const eventId = element.id.replace('countdown-', '');
                const event = demoEvents.find(e => e.id === eventId);
                
                if (event) {
                    updateCountdown(element, event.start_date, event.end_date);
                    
                    // Update every second
                    setInterval(() => {
                        updateCountdown(element, event.start_date, event.end_date);
                    }, 1000);
                }
            });
        }
        
        function updateCountdown(element, startDate, endDate) {
            const now = new Date();
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            let targetDate, prefix;
            
            if (now < start) {
                targetDate = start;
                prefix = "Starts in ";
            } else if (now < end) {
                targetDate = end;
                prefix = "Ends in ";
            } else {
                element.textContent = "‚è∞ Event Ended";
                element.parentElement.parentElement.parentElement.classList.add('expired-event');
                return;
            }
            
            const timeDiff = targetDate - now;
            const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
            
            if (days > 0) {
                element.textContent = `‚è∞ ${prefix}${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                element.textContent = `‚è∞ ${prefix}${hours}h ${minutes}m ${seconds}s`;
            } else {
                element.textContent = `‚è∞ ${prefix}${minutes}m ${seconds}s`;
            }
        }
        
        // Add completed challenge example
        function addCompletedChallengeExample() {
            const myChallengesContainer = document.getElementById('my-challenges-grid');
            
            const completedCard = document.createElement('div');
            completedCard.className = 'bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-sm p-6 text-white relative overflow-hidden';
            
            completedCard.innerHTML = `
                <div class="absolute top-0 right-0 w-20 h-20 bg-white/10 rounded-full -translate-y-10 translate-x-10"></div>
                <div class="absolute bottom-0 left-0 w-16 h-16 bg-white/10 rounded-full translate-y-8 -translate-x-8"></div>
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-4">
                        <div class="text-3xl">üèÉ‚Äç‚ôÄÔ∏è</div>
                        <div class="bg-white/20 px-3 py-1 rounded-full text-sm font-medium">
                            COMPLETED ‚ú®
                        </div>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">Morning Jog Challenge</h3>
                    <div class="text-white/90 text-sm mb-4">
                        üéâ Congratulations! You completed this 14-day challenge and earned 150 bonus points!
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-sm">
                            <div class="font-medium">Perfect Streak: 14 days üî•</div>
                            <div class="text-white/80">Completed 3 days ago</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold">+150</div>
                            <div class="text-sm text-white/80">bonus pts</div>
                        </div>
                    </div>
                </div>
            `;
            
            myChallengesContainer.appendChild(completedCard);
        }

        // Make all functions globally available
        window.showTab = showTab;
        window.joinChallenge = joinChallenge;
        window.markDone = markDone;
        window.joinEvent = joinEvent;
        window.showEventDetails = showEventDetails;
        window.showCreateChallenge = showCreateChallenge;
        window.showCreateEvent = showCreateEvent;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default tab
            showTab('challenges');
            
            // Load demo data immediately
            loadDemoData();
            
            // Initialize LIFF (but don't wait for it)
            initLIFF().catch(() => {
                console.log('LIFF failed, using demo mode');
            });
        });
        
        // Load demo data function
        function loadDemoData() {
            console.log('Loading demo data...');
            
            // Load demo challenges
            const challengeGrid = document.getElementById('challenge-board-grid');
            if (challengeGrid) {
                challengeGrid.innerHTML = '';
                demoChallenges.forEach(challenge => {
                    const challengeCard = createChallengeCard(challenge);
                    challengeGrid.appendChild(challengeCard);
                });
                console.log('Demo challenges loaded');
            }
            
            // Load demo events
            const eventsContainer = document.getElementById('events-container');
            if (eventsContainer) {
                eventsContainer.innerHTML = '';
                demoEvents.forEach(event => {
                    const eventCard = createEventCard(event);
                    eventsContainer.appendChild(eventCard);
                });
                startEventCountdowns();
                console.log('Demo events loaded');
            }
            
            // Load demo user challenges
            loadDemoUserChallenges();
            console.log('Demo user challenges loaded');
            
            // Load demo leaderboard
            displayLeaderboard(demoLeaderboard);
            console.log('Demo leaderboard loaded');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97c30e3306187b42',t:'MTc1NzM4Mjg0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
