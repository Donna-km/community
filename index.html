<!-- PATCHED index.html for Donna-km/community -->

<!-- ... file head unchanged ... -->

<script>
    // ... config and initialization code ...

    // Ensure progress bar UI updates after submit
    async function handleSubmitProgress() {
        // ... existing code ...
        try {
            // Database update logic...
            await loadAllData();
            updateProgressBarUI(); // New: direct progress bar UI update after reload
            closePhotoModal();
            // ... existing code ...
        } catch (error) {
            // ... error handling ...
        }
    }

    // Dummy function for progress bar UI update (replace with your real logic!)
    function updateProgressBarUI() {
        // For example:
        document.querySelectorAll('.progress-bar').forEach(bar => {
            // Update bar width, etc. based on new data
            // Example:
            bar.style.width = "100%"; // Or set based on progress state
        });
    }

    // Add Event photo validation
    async function createEvent(eventData) {
        if (useSupabase && isAdmin) {
            try {
                let imagesArray = Array.isArray(eventData.images) ? eventData.images : [];
                if (imagesArray.length === 0) {
                    showToast('Please add at least one photo.');
                    return;
                }
                // ... insert event with images: JSON.stringify(imagesArray) ...
            } catch (error) {
                showToast('Error creating event: ' + error.message);
            }
        }
    }

    // Leaderboard: show all users from Supabase
    async function loadLeaderboard() {
        let leaderboard = [];
        if (useSupabase) {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('id, username, total_points, avatar_emoji, profile_picture_url, is_admin')
                    .order('total_points', { ascending: false })
                    .limit(50); // Show top 50
                if (error) throw error;
                leaderboard = data || [];
            } catch (error) {
                console.error('Leaderboard error:', error);
            }
        } else {
            leaderboard = demoData.leaderboard || [];
        }
        renderLeaderboard(leaderboard);
    }

    // Render all leaderboard users
    function renderLeaderboard(leaderboard) {
        const list = document.getElementById('leaderboardList');
        list.innerHTML = leaderboard.map(user => `
            <div class="user-rank flex items-center space-x-3 p-2 border-b">
                <img src="${user.profile_picture_url || '/default-avatar.png'}" alt="User Photo" class="w-10 h-10 rounded-full">
                <span class="font-bold">${user.username || user.name}</span>
                <span class="ml-auto text-red-600 font-bold">${user.total_points}</span>
            </div>
        `).join('');
    }
</script>

<!-- ... rest of file unchanged ... -->